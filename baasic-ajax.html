<!--
Copyright (c) 2014 Mono d.o.o. All rights reserved.
Code distributed by Mono as a part of the Baasic project
-->

<!--
@group Baasic Polymer Elements

The `baasic-ajax` element inherits the core-ajax element, adding the additional authentication and access token sliding expiration functionality.

@element baasic-ajax
@status beta
@homepage www.baasic.com
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../baasic-globals/globals-import.html">
<link rel="import" href="../core-ajax/core-ajax.html">

<polymer-element name="baasic-ajax" extends="core-ajax">
    <template>
        <shadow>
        </shadow>
    </template>
    <script>
        Polymer('baasic-ajax', {
            go: function () {
                var headers = this.headers || {};
                var baasicUser = Baasic.Cache.getItem('baasicUser');
                if (baasicUser && baasicUser.accessToken) {
                    headers['Authorization'] = baasicUser.tokenType + ' ' + baasicUser.accessToken;
                    //referesh token sliding expiration time
                    baasicUser.expiresAbsolute = new Date(new Date().getTime() + (baasicUser.expiresIn * 1000));
                    Baasic.Cache.setItem('baasicUser', baasicUser, {
                        expirationAbsolute: baasicUser.expiresAbsolute,
                        expirationSliding: null,
                        priority: Cache.Priority.HIGH,
                        callback: null
                    });
                }
                else if (!headers['Authorization']) {
                    headers['Authorization'] = '';
                }
                this.headers = headers;

                this.super();
            },
            //dirty fix for problems with sync calls introduced in versions of core-ajax greater than 0.3.3; TODO: find a better solution
            processResponse: function (xhr) {
                var response = this.evalResponse(xhr);
                this.response = response;
                this.fire('core-response', { response: response, xhr: xhr });
            }
        });
    </script>
</polymer-element>